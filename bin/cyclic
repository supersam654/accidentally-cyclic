#!/usr/bin/env node
'use strict'

const fs = require('fs')
const path = require('path')

const ArgumentParser = require('argparse').ArgumentParser

const cyclic = require('../cyclic')

// I refuse to import a whole package for this.
function sprintf (format) {
  var args = Array.prototype.slice.call(arguments, 1)
  return format.replace(/{(\d+)}/g, function (match, number) {
    return typeof args[number] !== 'undefined' ? args[number] : match
  })
}

function parseArguments () {
  const parser = new ArgumentParser({
    version: require('../package.json').version,
    addHelp: true,
    description: 'Create internal dependency graph of Node.js project.'
  })

  parser.addArgument(
    ['--json'],
    {
      help: 'Output dependencies directly as a JSON array to a file'
    }
  )
  parser.addArgument(
    ['--html'],
    {
      help: 'Output dependency graph to a self-contained HTML file'
    }
  )
  parser.addArgument(
    ['-a', '--all'],
    {
      action: 'storeTrue',
      help: 'Include dependencies from node_modules'
    }
  )
  parser.addArgument(
    'mainFile',
    {
      help: 'Entry file of the project to get dependencies for'
    }
  )
  return parser.parseArgs()
}

function main (args) {
  let mainFile = args.mainFile
  // Prepend './' to relative paths that don't already have them.
  // `require` paths need to start with './' if they are relative but system paths do not.
  try {
    fs.accessSync(mainFile)
    // If `accessSync` didn't throw, this is a relative path or an absolute path to a file.
    if (!path.isAbsolute(mainFile)) {
      // Make sure relative paths are formatted correctly for `require`
      mainFile = path.resolve(process.cwd(), mainFile)
    }
  } catch (_) {
    // This must be a core module or third-party module so don't do anything.
  }
  // TODO: Revert chdir change if this ever gets used outside of a CLI.
  process.chdir(path.dirname(mainFile))
  cyclic.require(mainFile, args.all)
  .then(dependencies => {
    for (let dep of dependencies) {
      // Shorten names even more for graph representation.
      dep.module = path.basename(dep.module)
      dep.parent = path.basename(dep.parent)
      console.log(dep)
    }

    const jsonData = JSON.stringify(dependencies, null, 2)

    // Note that you can export as json and html if you so please.
    if (args.json) {
      fs.writeFileSync(args.json, jsonData)
    }
    if (args.html) {
      const htmlTemplate = fs.readFileSync('./html_template/index.tmpl.html').toString()
      const frontendJS = fs.readFileSync('./html_template/script.js').toString()
      const htmlData = sprintf(htmlTemplate, jsonData, frontendJS)
      fs.writeFileSync(args.html, htmlData)
    }
  })
  .catch(e => {
    console.warn(e)
  })
}

main(parseArguments())
